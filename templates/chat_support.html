<!DOCTYPE html>
<html>
<head>
    <title>Chat Support â€“ ReTech</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f5f7fa; }
        .navbar-brand span { color: #28a745; font-weight: bold; }

        .dropdown-hover { position: relative; cursor: pointer; }
        .dropdown-hover:hover > .dropdown-menu { display: block; }
        .dropdown-menu { display: none; }

        .box {
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="/">Re<span>Tech</span></a>

        <div class="ms-auto dropdown-hover">
            <span class="fw-bold text-primary">ðŸ‘¤ {{ session.user.name }}</span>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="/profile">Profile</a></li>
                <li><a class="dropdown-item" href="/orders">My Orders</a></li>
                <li><a class="dropdown-item" href="/cart">Cart</a></li>
                <li><a class="dropdown-item" href="/change_password">Change Password</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="/logout">Logout</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <h4>ðŸ’¬ Chat Support</h4>

    <div class="card p-3 mt-3 mb-4" id="chatBox">
        <div><strong>Bot:</strong> Hi {{ session.user.name }} ðŸ‘‹ How can I help you?</div>
    </div>

    <button class="btn btn-outline-primary btn-sm me-2" onclick="ask('order')">Order Status</button>
    <button class="btn btn-outline-primary btn-sm me-2" onclick="ask('refund')">Refund</button>
    <button class="btn btn-outline-primary btn-sm me-2" onclick="ask('delivery')">Delivery</button>
    <button class="btn btn-outline-danger btn-sm" onclick="manual()">Other Issue</button>

    <div class="mt-4 d-none" id="manualBox">
        <textarea class="form-control" id="problem" placeholder="Describe your issue..."></textarea>
        <button class="btn btn-success mt-2" onclick="sendProblem()">Send</button>
    </div>

    <!-- ðŸ”¥ DELETE ACCOUNT -->
    <hr class="my-5">

    <div class="box border border-danger">
        <h5 class="text-danger">âš  Delete Account</h5>
        <p class="text-muted">This action is permanent and cannot be undone.</p>

        <button class="btn btn-danger" onclick="sendDeleteOTP()">
            Send OTP to Delete Account
        </button>

        <div id="deleteOtpBox" class="mt-3 d-none">
            <input class="form-control mb-2" id="deleteOtp" placeholder="Enter OTP">
            <button class="btn btn-danger w-100" onclick="confirmDelete()">
                Confirm & Delete
            </button>
        </div>
    </div>
</div>

<script>
function ask(q) {
    fetch("/chat-answer", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({question: q})
    })
    .then(r => r.json())
    .then(d => {
        chatBox.innerHTML += `<div><b>You:</b> ${q}</div>`;
        chatBox.innerHTML += `<div><b>Bot:</b> ${d.reply}</div>`;
    });
}

function manual() {
    document.getElementById("manualBox").classList.remove("d-none");
}

function sendProblem() {
    fetch("/chat-send-mail", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: "message=" + encodeURIComponent(problem.value)
    }).then(() => alert("Sent to support"));
}

// ðŸ”¥ DELETE ACCOUNT
function sendDeleteOTP() {
    fetch("/delete-account/send-otp", { method: "POST" })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            alert("OTP sent to your email");
            deleteOtpBox.classList.remove("d-none");
        }
    });
}

function confirmDelete() {
    fetch("/delete-account/confirm", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ otp: deleteOtp.value })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            alert("Account deleted");
            window.location.href = "/";
        } else {
            alert(d.error);
        }
    });
}
</script>

</body>
</html>
